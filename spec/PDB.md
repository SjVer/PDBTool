# Program Database (PDB)

The Program Database format (PDB) is a file format that contains debug information for use by debuggers and other tools.

(See [LLVM's PDB format documentation](https://llvm.org/docs/PDB/index.html) and [Microsoft's GitHub repo](https://github.com/Microsoft/microsoft-pdb).)

## File Layout

PDB files are formatted using the Multi-Stream Format (MSF), where different streams contain different parts of the debugging information, such as types, source files, etc..

(See [MSF.md](MSF.md).)

## The Streams

The streams contained in a PDB files are as follows:

**Old Directory** stream, **at index 0**, contains:
- The previous MSF stream directory

**PDB** stream, **at index 1**, contains:
- Basic file information
- Fields to match EXE to PDB
- Map of named streams

**TPI** stream, **at index 2**, contains:
- CodeView type records 
- Index of TPI Hash Stream

**DBI** stream, **at index 3**, contains:
- Compiland (compilation unit) information
- Indices of module streams
- Indices of public/global streams
- Section contribution information
- Source file information
- References to FPO/PGO data streams

**IPI** stream, **at index 4**, contains:
- CodeView type records
- Index of IPI hash stream

**/src/headerblock** stream, at index specified by PDB stream's named stream map, contains:
- Summary of embedded source file content (e.g. natvis files)

**/names** stream, at index specified by PDB stream's named stream map, contains:
- PDB-wide global string table used for string de-duplication

**Module Info** stream, one for each compiland, at index specified by DBI stream, contains:
- CodeView symbol records for this module
- Line number information

**Public** stream, at index specified by DBI stream, contains:
- Public (exported) symbol records
- Index of Public Hash stream

**Global** stream, at index specified by DBI stream, contains:
- Single combined symbol table
- Index of Global Hash stream

**TPI Hash** stream, at index specified by TPI stream, contains:
- Hash table for looking up TPI records by name

**IPI Hash** stream, at index specified by IPI stream, contains:
- Hash table for looking up IPI records by name

There is another stream, "/LinkInfo", but what it contains is a mistery.

## The PDB Stream

At offset 0:

```cpp
struct PdbStreamHeader {
  ulittle32_t Version;
  ulittle32_t Signature;
  ulittle32_t Age;
  Guid UniqueId;
};
```

- **Signature**: A 32-bit timestamp generated by `time()` from when the PDB file was written. (Generally left unused.)
- **Age**: The number of times the PDB file has been written. Can be used with the GUID to match to an EXE file.
- **UniqueID**: A 128-bit identifier guaranteed to be unique.

`Version` is one of the following enum:

```cpp
enum PdbVersion {
  VC2 = 19941610,
  VC4 = 19950623,
  VC41 = 19950814,
  VC50 = 19960307,
  VC98 = 19970604,
  VC70Dep = 19990604,
  VC70 = 20000404,
  VC80 = 20030901,
  VC110 = 20091201,
  VC140 = 20140508,
};
```

[According to LLVM](https://llvm.org/docs/PDB/PdbStream.html#stream-header) the version is always just `VC70`, and the rest of these PDB docs might not apply to other versions.

### The Named Stream Map

Following the header is a serialized hash table mapping stream names to stream indices.

The on-disk layout consists of a single string buffer prefixed by a 32-bit length and the actual hash map, which consists of pairs of string buffer indices and the values, stream indices:

```cpp
struct HashMap {
  ulittle32_t Size;
  ulittle32_t Capacity;
  uint8_t PresentBitVector[Capacity / 8];
  uint8_t DeletedBitVector[Capacity / 8];
  struct { ulittle32_t Key; ulittle32_t Value; } Buckets[];
}
```

- **Size**: The number of pairs in the table.
- **Capacity**: The capacity the table.
- **Present Bit Vector**: A serialized bit vector marking which buckets are used.
- **Deleted Bit Vector**: A serialized bit vector marking which buckets are deleted.

**NOTE:** The actual number of pairs in the raw data seems to be `Size + 1`, and the `Capacity` should probably be used to determine the number of buckets in the deserialized hash map.

Note that the length of this map is not specified, so it needs to be parsed entirely to figure out what comes after.

### PDB Feature Codes

Following the named stream map, and consuming all remaining bytes of the PDB stream is a list of 32-bit feature flags:

```cpp
enum PdbFeatureFlag {
  VC110 = 20091201,
  VC140 = 20140508,
  NoTypeMerge = 0x4D544F4E,
  MinimalDebugInfo = 0x494E494D,
};
```

- **VC110**: This is the last flag; the PDB file contains an IPI stream.
- **VC140**: Other feature flags may be present; the PDB file contains an IPI stream.
- **NoTypeMerge**: There might be duplicate types in the TPI stream. Why is unclear.
- **MinimalDebugInfo**: The program was linked with `/DEBUG:FASTLINK`. There is no TPI/IPI stream.

###

<br>

For mapping a PDB to an EXE, see [LLVM's PDB spec](https://llvm.org/docs/PDB/PdbStream.html#matching-a-pdb-to-its-executable).